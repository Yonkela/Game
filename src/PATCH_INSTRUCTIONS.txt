// Patch instructions for main.js to add save slot system

// 1. After safeSet method (around line 235), add these methods:

  // ---- Save slot system ----
  getCurrentSaveSlot() {
    try {
      return localStorage.getItem('currentSaveSlot') || 'default';
    } catch (e) {
      return 'default';
    }
  }

  loadSlotData() {
    const slotName = this.getCurrentSaveSlot();
    try {
      const saveKey = `save_${slotName}`;
      const saveData = localStorage.getItem(saveKey);
      if (!saveData) {
        return {
          money: 0,
          cookSpeed: 1,
          upgradeOvenSpeed: 0,
          upgradeEarnRate: 0,
          upgradePatience: 0,
          upgradePlayerSpeed: 0
        };
      }
      const parsed = JSON.parse(saveData);
      return {
        money: parsed.money || 0,
        cookSpeed: parsed.cookSpeed || 1,
        upgradeOvenSpeed: parsed.upgradeOvenSpeed || 0,
        upgradeEarnRate: parsed.upgradeEarnRate || 0,
        upgradePatience: parsed.upgradePatience || 0,
        upgradePlayerSpeed: parsed.upgradePlayerSpeed || 0
      };
    } catch (e) {
      this.logWarn('Failed to load slot data');
      return {
        money: this.safeGetInt('money'),
        cookSpeed: this.safeGetFloat('cookSpeed', 1),
        upgradeOvenSpeed: this.safeGetInt('upgradeOvenSpeed'),
        upgradeEarnRate: this.safeGetInt('upgradeEarnRate'),
        upgradePatience: this.safeGetInt('upgradePatience'),
        upgradePlayerSpeed: this.safeGetInt('upgradePlayerSpeed')
      };
    }
  }

  saveSlotData() {
    const slotName = this.getCurrentSaveSlot();
    const saveData = {
      money: this.money || 0,
      cookSpeed: this.cookSpeed || 1,
      upgradeOvenSpeed: (this.upgrades && this.upgrades.ovenSpeed) || 0,
      upgradeEarnRate: (this.upgrades && this.upgrades.earnRate) || 0,
      upgradePatience: (this.upgrades && this.upgrades.patience) || 0,
      upgradePlayerSpeed: (this.upgrades && this.upgrades.playerSpeed) || 0,
      timestamp: Date.now()
    };
    
    try {
      const saveKey = `save_${slotName}`;
      localStorage.setItem(saveKey, JSON.stringify(saveData));
      this.safeSet('money', this.money);
      this.safeSet('cookSpeed', this.cookSpeed || 1);
      this.safeSet('upgradeOvenSpeed', saveData.upgradeOvenSpeed);
      this.safeSet('upgradeEarnRate', saveData.upgradeEarnRate);
      this.safeSet('upgradePatience', saveData.upgradePatience);
      this.safeSet('upgradePlayerSpeed', saveData.upgradePlayerSpeed);
      return true;
    } catch (e) {
      this.logWarn('Failed to save slot data');
      return false;
    }
  }

// 2. Replace game state loading (around line 173) with:
    // Game state (load from current save slot)
    const saveData = this.loadSlotData();
    this.money = saveData.money;
    this.cookSpeed = saveData.cookSpeed;
    this.isCooking = false;

// 3. Replace upgrade initialization (around line 185) with:
    // Initialize upgrade state from save
    this.upgrades = {
      ovenSpeed: saveData.upgradeOvenSpeed,
      earnRate: saveData.upgradeEarnRate,
      patience: saveData.upgradePatience,
      playerSpeed: saveData.upgradePlayerSpeed
    };

// 4. Replace saveGame method (around line 940) with:
  saveGame(){
    this.saveSlotData();
    const el = document.getElementById('saveStatus'); if(el) el.textContent = 'Saved';
    this.time && this.time.delayedCall && this.time.delayedCall(900, ()=>{ if(el) el.textContent = ''; }, [], this);
  }

// 5. Replace window.onload (around line 971) with:
let gameInstance = null;

window.startPhaserGame = ()=>{
  if(gameInstance) {
    gameInstance.destroy(true);
  }
  gameInstance = new Phaser.Game(config);
  gameInstance.events.on('step', ()=>{
    const scene = gameInstance.scene.getScene('MainScene');
    if(scene){
      scene.updateUI();
      window.gameScene = scene;
    }
  });
};

window.onload = ()=>{
  // Don't start game automatically, wait for menu selection
};
